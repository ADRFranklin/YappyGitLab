<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Discord/Client.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ChannelConfig.html">ChannelConfig</a></li><li><a href="ChannelConfigItem.html">ChannelConfigItem</a></li><li><a href="Client.html">Client</a></li><li><a href="Command.html">Command</a></li><li><a href="Gitlab.html">Gitlab</a></li><li><a href="Module.html">Module</a></li><li><a href="Util.html">Util</a></li></ul><h3>TypeDefs</h3><ul><li><a href="global.html#ChannelConfigSchema">ChannelConfigSchema</a></li><li><a href="global.html#ClientOptions">ClientOptions</a></li><li><a href="global.html#CommandConfig">CommandConfig</a></li><li><a href="global.html#CommandHelp">CommandHelp</a></li></ul><h3>Externals</h3><ul><li><a href="external-Channel.html">Channel</a></li><li><a href="external-Client.html">Client</a></li><li><a href="external-ClientOptions.html">ClientOptions</a></li><li><a href="external-Collection.html">Collection</a></li><li><a href="external-ColorResolvable.html">ColorResolvable</a></li><li><a href="external-Message.html">Message</a></li><li><a href="external-RichEmbed.html">RichEmbed</a></li></ul>
</nav>

<div id="main">
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const Discord = require('discord.js');
const DiscordClient = Discord.Client;
const ChannelConfig = require('../Models/ChannelConfig');
const fs = require('fs');
const Log = require('../Util/Log');

/**
* @typedef {external:ClientOptions} ClientOptions
* @property {String} prefix discord bot's prefix
* @property {String} owner discord bot's owner user id
* @property {String} [name] discord bot's name
*/

/**
* Yappy's custom Discord client
* @extends {external:Client}
*/
class Client extends DiscordClient {

  /**
  * The main hub for interacting with the Discord API, and the starting point for any bot.
  * @param {ClientOptions}
  */
  constructor(opts = {}) {
    super(opts);

    /**
     * Discord bot's commands
     * @type {external:Collection}
     */
    this.commands = new Discord.Collection();

    /**
     * Discord bot's middleware
     * @type {external:Collection}
     */
    this.middleware = new Discord.Collection();

    /**
     * Discord bot's command aliases
     * @type {external:Collection}
     */
    this.aliases = new Discord.Collection();

    /**
     * Discord bot's prefix
     * @type {String}
     */
    this.prefix = opts.prefix;

    /**
     * Discord bot's name
     * @type {String}
     */
    this.name = opts.name || 'Unknown';

    this.config = {
      owner: opts.owner,
    };
  }

  /**
  * Load commands from directory
  * @param {String} cwd path to commands directory
  */
  loadCommands(cwd) {
    fs.readdir(cwd, (err, files) => {
      if (err) {
        this.emit('error', err);
        return this;
      }

      if (!files.length) {
        Log.info(`Command | No Commands Loaded.`);
        return this;
      }

      files.forEach(f => {
        try {
          let Command = require(`./Commands/${f}`);

          Command = new Command(this);
          Log.info(`Command | Loading ${Command.help.name}. ðŸ‘Œ`);
          Command.props.help.file = f;

          this.commands.set(Command.help.name, Command);

          Command.conf.aliases.forEach(alias => {
            this.aliases.set(alias, Command.help.name);
          });
        } catch (error) {
          this.emit('error', `Command | ${f}`, error);
        }
      });
      return this;
    });
  }

  /**
  * Load modules from directory
  * @param {String} cwd path to modules directory
  */
  loadModules(cwd) {
    fs.readdir(cwd, (err, files) => {
      if (err) {
        this.emit('error', err);
        return this;
      }

      if (!files.length) {
        Log.info(`Module | No Modules Loaded.`);
        return this;
      }

      files.forEach(f => {
        try {
          const module = new (require(`./Modules/${f}`))(this);
          const name = module.constructor.name.replace('Module', '');

          Log.info(`Module | Loading ${name}. ðŸ‘Œ`);

          this.middleware.set(name, module);
        } catch (error) {
          this.emit('error', `Module | ${f}`, error);
        }
      });
      return this;
    });
  }

  /**
  * Reload command
  * @param {String} command command to reload
  * @return {Promise}
  */
  reloadCommand(command) {
    return new Promise((resolve, reject) => {
      try {
        delete require.cache[require.resolve(`./Commands/${command}`)];
        Log.info(`Command | Reloading ${command} ðŸ‘Œ`);
        let cmd = require(`./Commands/${command}`);
        let Command = new cmd(this);
        Command.props.help.file = command;
        this.commands.set(Command.help.name, Command);
        Command.conf.aliases.forEach(alias => {
          this.aliases.set(alias, Command.help.name);
        });
        resolve();
      } catch (e) {
        reject(e);
      }
    });
  }

  /**
   * Reload file
   * @param {String} file path of file to reload
   * @return {Promise&lt;any>}
   */
  reloadFile(file) {
    return new Promise((resolve, reject) => {
      try {
        delete require.cache[require.resolve(file)];
        let thing = require(file);
        resolve(thing);
      } catch (e) {
        reject(e);
      }
    });
  }

  /**
   * Message event handling, uses modules (aka middleware)
   * @param {external:Message} msg
   * @return {Client}
   */
  run(msg) {
    if (msg.author.equals(this.user) || msg.author.bot) return;
    let channelConf = ChannelConfig.FindByChannel(msg.channel.id) || {};
    let prefix = channelConf.prefix || Math.random();
    if (!msg.content.startsWith(this.user.toString()) &amp;&amp; !msg.content.startsWith(prefix) &amp;&amp; !msg.content.startsWith(this.prefix)) return false;

    let content = (msg.content.startsWith(prefix) &amp;&amp; msg.content.replace(prefix, '')) || (msg.content.startsWith(this.user.toString()) &amp;&amp; msg.content.replace(`${this.user.toString()} `, '')) || (msg.content.startsWith(this.prefix) &amp;&amp; msg.content.replace(this.prefix, '')) || msg.content;
    let command = content.split(' ')[0].toLowerCase();
    let args = content.split(' ').slice(1);

    let middleware = this.middleware.array().sort((a, b) => b.priority - a.priority);
    let i = 0;

    const handleErr = (err, currentMiddleware) =>
    middleware[middleware.length - 1].run(msg, args, next, currentMiddleware, err);

    const next = (err) => {
      let currentMiddleware = middleware[i] || middleware[i - 1];
      let nextMiddleware = middleware[i++];
      if (err) return handleErr(err, currentMiddleware);
      if (nextMiddleware) {
        try {
          const thisMiddleware = nextMiddleware.run(msg, args, next, command);
          if (thisMiddleware.catch &amp;&amp; typeof thisMiddleware.catch === 'function') {
            thisMiddleware.catch(e => handleErr(e, nextMiddleware || currentMiddleware));
          }
        } catch (e) {
          handleErr(err, nextMiddleware || currentMiddleware);
        }
      }
    };

    next();

    return this;
  }

  /**
   * Calculates permissions from message member
   * @param {external:Message} msg
   * @return {Number} Permission level
   */
  permissions(msg) {
    /* This function should resolve to an ELEVATION level which
    is then sent to the command handler for verification*/
    let permlvl = 0;

    if (msg.member &amp;&amp; msg.member.hasPermission(`ADMINISTRATOR`)) permlvl = 1;
    if (this.config.owner === msg.author.id) permlvl = 2;

    return permlvl;
  }
}

module.exports = Client;
</code></pre>
        </article>
    </section>





</div>

<br class="clear">

<footer>
	<div align="right">
    	<a href="https://github.com/jsdoc3/jsdoc">JSDoc3.4.3</a> | Minami
	</div>
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
